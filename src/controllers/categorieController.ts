import { Response, NextFunction } from 'express';
import { AuthenticatedRequest } from '../types'; // ‚úÖ On importe notre type personnalis√©
import { getCategoriesByEmploye, getCategorieById, addCategorie, deleteCategorie } from '../models/categorieModel';

// üîç R√©cup√©rer toutes les cat√©gories accessibles par un employ√©
export const getCategories = async (req: AuthenticatedRequest, res: Response, next: NextFunction): Promise<void> => {
    try {
        if (!req.user) {
            res.status(401).json({ message: "‚õî Acc√®s non autoris√©." });
            return;
        }

        const categories = await getCategoriesByEmploye(req.user.employeMail);
        res.status(200).json(categories);
    } catch (error) {
        next(error);
    }
};

// üîç R√©cup√©rer une cat√©gorie par ID (avec restriction d'acc√®s)
export const getCategorie = async (req: AuthenticatedRequest, res: Response, next: NextFunction): Promise<void> => {
    try {
        if (!req.user) {
            res.status(401).json({ message: "‚õî Acc√®s non autoris√©." });
            return;
        }

        const { id } = req.params;
        const categorie = await getCategorieById(req.user.employeMail, Number(id));
        if (!categorie) {
            res.status(404).json({ message: "‚ùå Cat√©gorie non trouv√©e ou acc√®s refus√©." });
            return;
        }

        res.status(200).json(categorie);
    } catch (error) {
        next(error);
    }
};

// ‚ûï Ajouter une cat√©gorie (ADMIN uniquement)
export const createCategorie = async (req: AuthenticatedRequest, res: Response, next: NextFunction): Promise<void> => {
    try {
        if (!req.user || !req.user.isAdmin) {
            res.status(403).json({ message: "‚õî Acc√®s interdit. Seuls les administrateurs peuvent cr√©er une cat√©gorie." });
            return;
        }

        const { nomCategorie } = req.body;
        if (!nomCategorie) {
            res.status(400).json({ message: "‚õî Le nom de la cat√©gorie est requis." });
            return;
        }

        await addCategorie(req.user.employeMail, { nomCategorie });
        res.status(201).json({ message: "‚úÖ Cat√©gorie cr√©√©e avec succ√®s." });
    } catch (error) {
        next(error);
    }
};

// ‚ùå Supprimer une cat√©gorie (ADMIN uniquement)
export const removeCategorie = async (req: AuthenticatedRequest, res: Response, next: NextFunction): Promise<void> => {
    try {
        if (!req.user || !req.user.isAdmin) {
            res.status(403).json({ message: "‚õî Acc√®s interdit. Seuls les administrateurs peuvent supprimer une cat√©gorie." });
            return;
        }

        const categorieID = parseInt(req.params.id, 10);
        await deleteCategorie(req.user.employeMail, categorieID);
        res.status(200).json({ message: "‚úÖ Cat√©gorie supprim√©e avec succ√®s." });
    } catch (error) {
        next(error);
    }
};
