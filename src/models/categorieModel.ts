import pool from '../config/dbconfig';
import { RowDataPacket } from 'mysql2';

export interface Categorie {
    categorieID?: number;
    nomCategorie: string;
}

// R√©cup√©rer toutes les cat√©gories
export const getCategoriesByEmploye = async (employeMail: string): Promise<Categorie[]> => {
    const [adminCheck] = await pool.query<RowDataPacket[]>(
        'SELECT isAdmin FROM employe WHERE employeMail = ?', [employeMail]
    );

    if (adminCheck.length === 0) return [];

    if (adminCheck[0].isAdmin) {
        // Admin ‚Üí voit toutes les cat√©gories
        const [rows] = await pool.query<RowDataPacket[]>('SELECT * FROM categorie');
        return rows as Categorie[];
    }

    // Employ√© classique ‚Üí voit seulement les cat√©gories auxquelles il est affect√©
    const [rows] = await pool.query<RowDataPacket[]>(
        `SELECT c.* 
         FROM categorie c
         LEFT JOIN affecter a ON c.categorieID = a.categorieID
         WHERE a.employeMail = ?`,
        [employeMail]
    );

    return rows as Categorie[];
};


// R√©cup√©rer une cat√©gorie par ID
export const getCategorieById = async (employeMail: string, id: number): Promise<Categorie | null> => {
    // V√©rifier si l'utilisateur est admin
    const [adminCheck] = await pool.query<RowDataPacket[]>(
        'SELECT isAdmin FROM employe WHERE employeMail = ?',
        [employeMail]
    );

    if (adminCheck.length > 0 && adminCheck[0].isAdmin) {
        // üî• Admin ‚Üí Il peut voir toutes les cat√©gories
        const [rows] = await pool.query<RowDataPacket[]>('SELECT * FROM categorie WHERE categorieID = ?', [id]);
        return rows.length > 0 ? (rows[0] as Categorie) : null;
    }

    // üî• Employ√© classique ‚Üí Il ne peut voir que les cat√©gories auxquelles il est affect√©
    const [rows] = await pool.query<RowDataPacket[]>(
        `SELECT c.* 
        FROM categorie c
        JOIN affecter a ON c.categorieID = a.categorieID
        WHERE c.categorieID = ? AND a.employeMail = ?`,
        [id, employeMail]
    );

    return rows.length > 0 ? (rows[0] as Categorie) : null;
};


// Ajouter une cat√©gorie
export const addCategorie = async (employeMail: string, categorie: Categorie): Promise<void> => {
    // V√©rifier si l'utilisateur est admin
    const [adminCheck] = await pool.query<RowDataPacket[]>(
        'SELECT isAdmin FROM employe WHERE employeMail = ?',
        [employeMail]
    );

    if (adminCheck.length === 0 || !adminCheck[0].isAdmin) {
        console.error(`‚õî Acc√®s refus√© : ${employeMail} n'est pas administrateur.`);
        throw new Error("Acc√®s refus√© : Seuls les administrateurs peuvent ajouter des cat√©gories.");
    }

    await pool.query('INSERT INTO categorie (nomCategorie) VALUES (?)', [categorie.nomCategorie]);
};


// Supprimer une cat√©gorie
export const deleteCategorie = async (employeMail: string, id: number): Promise<void> => {
    // V√©rifier si l'utilisateur est admin
    const [adminCheck] = await pool.query<RowDataPacket[]>(
        'SELECT isAdmin FROM employe WHERE employeMail = ?',
        [employeMail]
    );

    if (adminCheck.length === 0 || !adminCheck[0].isAdmin) {
        console.error(`‚õî Acc√®s refus√© : ${employeMail} n'est pas administrateur.`);
        throw new Error("Acc√®s refus√© : Seuls les administrateurs peuvent supprimer des cat√©gories.");
    }

    await pool.query('DELETE FROM categorie WHERE categorieID = ?', [id]);
};
